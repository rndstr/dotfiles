#!/bin/bash
#
# Takes a screenshot from your desktops or windows
#
# USAGE
#   screenie.sh [area] [--name|-n file] [--target|-t dir] [--viewer|-v command]
#
#     area              w|d|t (window, desktop, tvtime)
#     --name            Name of the file (w/o extension)
#
# DEPS
#   kde-base/kdialog
#   media-gfx/imagemagick
#   x11-apps/xwd
#
# NOTE
#   tvtime area appends /tvtime to target


# DEFAULT SETTINGS

# Where to store the file
TARGET=~/screens
# Name of the shot without the extension
FILENAME="screen-$(date +%Y%m%d_%H%M%S)"
# What to execute after screenshot was taken
VIEWER=
# Image extension
EXT=png

# Default area
# d = desktop, w = window, t = tvtime
AREA='d'

# Whether to ask for a name (if filename is given we always skip this)
ASKRENAME=1


TMPDIR=${TMPDIR:-/tmp}

while [ $# -gt 0 ]; do
  case "$1" in
    -t|--target) shift ; TARGET=$1; shift ;;
    -v|--viewer) shift ; VIEWER=$1; shift ;;
    -f|--name) shift ; FILENAME=$1; ASKRENAME=0; shift ;;
    *) AREA=$1; shift ;;
  esac
done

[ "$AREA" = "t" ] && TARGET+=/tvtime

[ ! -e $TARGET ] && mkdir $TARGET

if [ "$AREA" = "t" ]; then
  tvtime-command SCREENSHOT "$TARGET/$FILENAME.$EXT"
else

  if [ "$AREA" = "d" ]; then
    import -window root $TARGET/$FILENAME.$EXT
  else
    xwd -out $TMPDIR/dummy.xwd
    convert $TMPDIR/dummy.xwd $TARGET/$FILENAME.$EXT
    rm -f $TMPDIR/dummy.xwd
  fi

  if [ $(which kdialog2 2>/dev/null) ]; then
    rename=$(kdialog --title "Save as (w/o ext)" --inputbox "New name (cancel for $FILENAME)")
  fi

  if [ -n "$rename" ]; then
    mv $TARGET/$FILENAME.$EXT $TARGET/$rename.$EXT
    FILENAME=$rename
  fi

  [ -n "$VIEWER" ] && $VIEWER $TARGET/$FILENAME.$EXT
  echo $TARGET/$FILENAME.$EXT
fi

